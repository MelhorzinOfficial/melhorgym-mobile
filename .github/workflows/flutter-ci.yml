name: Flutter CI/CD

on:
 push:
  branches: [main, 'release/**']

env:
 FLUTTER_VERSION: stable
 JAVA_VERSION: '17'

jobs:
 # ──────────────────────────────────────────────
 # Job 1: Testes e análise (roda sempre)
 # ──────────────────────────────────────────────
 test:
  name: Test & Analyze
  runs-on: ubuntu-latest
  steps:
   - name: Checkout repository
     uses: actions/checkout@v4

   - name: Flutter action
     uses: subosito/flutter-action@v2.21.0
     with:
      channel: ${{ env.FLUTTER_VERSION }}
      cache: true

   - name: Install dependencies
     run: flutter pub get

   - name: Analyze code
     run: flutter analyze

   - name: Run tests
     run: flutter test

 # ──────────────────────────────────────────────
 # Job 2: Build Android (APK + AAB)
 # ──────────────────────────────────────────────
 build-android:
  name: Build Android
  needs: test
  runs-on: ubuntu-latest
  steps:
   - name: Checkout repository
     uses: actions/checkout@v4

   - name: Set up Java
     uses: actions/setup-java@v4
     with:
      distribution: temurin
      java-version: ${{ env.JAVA_VERSION }}

   - name: Flutter action
     uses: subosito/flutter-action@v2.21.0
     with:
      channel: ${{ env.FLUTTER_VERSION }}
      cache: true

   - name: Install dependencies
     run: flutter pub get

   # Versão: major.minor.patch do pubspec + build number = run number
   - name: Set version
     id: version
     run: |
      VERSION=$(grep 'version:' pubspec.yaml | sed 's/version: //' | sed 's/+.*//')
      BUILD_NUMBER=${{ github.run_number }}
      echo "version=${VERSION}" >> $GITHUB_OUTPUT
      echo "build_number=${BUILD_NUMBER}" >> $GITHUB_OUTPUT
      echo "full_version=${VERSION}+${BUILD_NUMBER}" >> $GITHUB_OUTPUT

   # ── release/* → APK para teste fora da loja ──
   - name: Build APK (teste)
     if: startsWith(github.ref, 'refs/heads/release/')
     run: |
      flutter build apk --release \
        --build-name=${{ steps.version.outputs.version }} \
        --build-number=${{ steps.version.outputs.build_number }}

   # ── main → APK + AAB para a loja ──
   - name: Build APK (produção)
     if: github.ref == 'refs/heads/main'
     run: |
      flutter build apk --release \
        --build-name=${{ steps.version.outputs.version }} \
        --build-number=${{ steps.version.outputs.build_number }}

   - name: Build AAB (Google Play)
     if: github.ref == 'refs/heads/main'
     run: |
      flutter build appbundle --release \
        --build-name=${{ steps.version.outputs.version }} \
        --build-number=${{ steps.version.outputs.build_number }}

   # ── Upload artefatos ──
   - name: Upload APK
     uses: actions/upload-artifact@v4
     with:
      name: apk-${{ steps.version.outputs.full_version }}
      path: build/app/outputs/flutter-apk/app-release.apk

   - name: Upload AAB
     if: github.ref == 'refs/heads/main'
     uses: actions/upload-artifact@v4
     with:
      name: aab-${{ steps.version.outputs.full_version }}
      path: build/app/outputs/bundle/release/app-release.aab

 # ──────────────────────────────────────────────
 # Job 3: Build iOS (IPA)
 # ──────────────────────────────────────────────
 build-ios:
  name: Build iOS
  needs: test
  runs-on: macos-latest
  steps:
   - name: Checkout repository
     uses: actions/checkout@v4

   - name: Flutter action
     uses: subosito/flutter-action@v2.21.0
     with:
      channel: ${{ env.FLUTTER_VERSION }}
      cache: true

   - name: Install dependencies
     run: flutter pub get

   - name: Set version
     id: version
     run: |
      VERSION=$(grep 'version:' pubspec.yaml | sed 's/version: //' | sed 's/+.*//')
      BUILD_NUMBER=${{ github.run_number }}
      echo "version=${VERSION}" >> $GITHUB_OUTPUT
      echo "build_number=${BUILD_NUMBER}" >> $GITHUB_OUTPUT
      echo "full_version=${VERSION}+${BUILD_NUMBER}" >> $GITHUB_OUTPUT

   # Build iOS sem assinatura (exporta para assinar depois)
   - name: Build iOS (no codesign)
     run: |
      flutter build ios --release --no-codesign \
        --build-name=${{ steps.version.outputs.version }} \
        --build-number=${{ steps.version.outputs.build_number }}

   # Gera o .ipa a partir do .app
   - name: Create IPA
     run: |
      mkdir -p Payload
      cp -r build/ios/iphoneos/Runner.app Payload/
      zip -r MelhorGym-${{ steps.version.outputs.full_version }}.ipa Payload

   - name: Upload IPA
     uses: actions/upload-artifact@v4
     with:
      name: ipa-${{ steps.version.outputs.full_version }}
      path: MelhorGym-${{ steps.version.outputs.full_version }}.ipa

 # ──────────────────────────────────────────────
 # Job 4: Cria Release no GitHub (somente main)
 # ──────────────────────────────────────────────
 create-release:
  name: Create GitHub Release
  if: github.ref == 'refs/heads/main'
  needs: [build-android, build-ios]
  runs-on: ubuntu-latest
  permissions:
   contents: write
  steps:
   - name: Checkout repository
     uses: actions/checkout@v4

   - name: Set version
     id: version
     run: |
      VERSION=$(grep 'version:' pubspec.yaml | sed 's/version: //' | sed 's/+.*//')
      BUILD_NUMBER=${{ github.run_number }}
      echo "version=${VERSION}" >> $GITHUB_OUTPUT
      echo "full_version=${VERSION}+${BUILD_NUMBER}" >> $GITHUB_OUTPUT

   - name: Download all artifacts
     uses: actions/download-artifact@v4
     with:
      path: artifacts

   - name: Create Release
     uses: softprops/action-gh-release@v2
     with:
      tag_name: v${{ steps.version.outputs.full_version }}
      name: Release v${{ steps.version.outputs.full_version }}
      body: |
       ## MelhorGym v${{ steps.version.outputs.full_version }}

       ### Artefatos
       - **APK** — Instalar diretamente no Android
       - **AAB** — Upload para Google Play Store
       - **IPA** — Build iOS (assinar com certificado antes de distribuir)

       _Build automático #${{ github.run_number }}_
      files: |
       artifacts/apk-*/*.apk
       artifacts/aab-*/*.aab
       artifacts/ipa-*/*.ipa
      draft: false
      prerelease: false
